<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Cooperativa</title>
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" href="favicon.png">
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
            background: #f5f5f5;
        }
        #app-iframe {
            width: 100%;
            height: 100vh;
            border: none;
            display: block;
        }
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 10000;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            transition: opacity 0.3s ease-out;
        }
        .loading.hidden {
            display: none !important;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        .error-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            max-width: 500px;
            text-align: center;
            z-index: 2000;
            display: none;
        }
        .error-message.show {
            display: block;
        }
        .error-message h2 {
            color: #d32f2f;
            margin-top: 0;
        }
        .error-message p {
            color: #666;
            line-height: 1.6;
            margin: 15px 0;
        }
        .error-message button {
            background: #2E7D32;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .error-message button:hover {
            background: #1B5E20;
        }
        .error-message a {
            color: #1976D2;
            text-decoration: none;
        }
        .error-message a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <p>Cargando aplicaci√≥n...</p>
    </div>
    
    <div class="error-message" id="error-message">
        <h2>‚ö†Ô∏è Error de Acceso</h2>
        <p>No se pudo cargar la aplicaci√≥n. Esto puede deberse a:</p>
        <ul style="text-align: left; color: #666;">
            <li>Problemas de permisos del Google Apps Script</li>
            <li>Restricciones de seguridad del navegador</li>
            <li>Problemas temporales de conexi√≥n</li>
        </ul>
        <p><strong>‚ö†Ô∏è Error 403 Detectado</strong></p>
        <p style="background: #FFEBEE; padding: 15px; border-radius: 5px; border-left: 4px solid #F44336; text-align: left;">
            <strong>Problema:</strong> Est√°s usando la URL de <strong>desarrollo</strong> (<code>/dev</code>) que solo funciona para el propietario del script.<br><br>
            <strong>Soluci√≥n:</strong> Debes desplegar la aplicaci√≥n web y usar la URL de <strong>producci√≥n</strong> (<code>/exec</code>).
        </p>
        <p><strong>Pasos para solucionar:</strong></p>
        <ol style="text-align: left; font-size: 14px; line-height: 1.8;">
            <li><strong>Ve a Google Apps Script</strong> y abre tu proyecto</li>
            <li><strong>Despliega la aplicaci√≥n:</strong>
                <ul style="margin-top: 5px;">
                    <li>Haz clic en <strong>"Implementar"</strong> ‚Üí <strong>"Nueva implementaci√≥n"</strong></li>
                    <li>Tipo: <strong>"Aplicaci√≥n web"</strong></li>
                    <li>Ejecutar como: <strong>"Yo"</strong> (tu cuenta)</li>
                    <li>Qui√©n tiene acceso: <strong>"Cualquiera"</strong> o <strong>"Cualquiera, incluso an√≥nimo"</strong></li>
                    <li>Haz clic en <strong>"Implementar"</strong></li>
                </ul>
            </li>
            <li><strong>Autoriza los permisos:</strong> La primera vez te pedir√° autorizar el acceso al Spreadsheet</li>
            <li><strong>Copia la URL de producci√≥n</strong> (termina en <code>/exec</code>, NO en <code>/dev</code>)</li>
            <li><strong>Actualiza la URL en este archivo</strong> (l√≠nea 157 y 136)</li>
            <li><strong>Verifica que el Spreadsheet</strong> est√© compartido con acceso de lectura para "Cualquiera con el enlace"</li>
        </ol>
        <p style="margin-top: 15px; padding: 15px; background: #E3F2FD; border-radius: 5px; border-left: 4px solid #1976D2;">
            <strong>üí° Soluci√≥n R√°pida:</strong><br>
            Google Apps Script tiene restricciones de seguridad que impiden cargar en iframes desde dominios externos (como GitHub Pages).<br>
            <strong>La aplicaci√≥n se abrir√° autom√°ticamente en una nueva ventana.</strong>
        </p>
        <p style="margin-top: 15px;">
            <a href="https://script.google.com/macros/s/AKfycbwNc7rWlhatDevQP242zv1BpZdbR0MpqtSSw_LjsNHAdVEhyYAMn5BAMvFEiiyhWqznmQ/exec" target="_blank" style="color: #1976D2; text-decoration: none; font-weight: bold;">‚Üí O haz clic aqu√≠ para abrir manualmente</a>
        </p>
        <button onclick="location.reload()" style="background: #757575;">Recargar P√°gina</button>
        <button onclick="document.getElementById('error-message').classList.remove('show')" style="background: #757575;">Cerrar</button>
    </div>
    
    <!-- 
        IMPORTANTE: 
        - Reemplaza /dev con la URL de PRODUCCI√ìN despu√©s de desplegar la aplicaci√≥n web
        - La URL de desarrollo (/dev) solo funciona para el propietario del script
        - Si el iframe falla, la aplicaci√≥n se redirigir√° autom√°ticamente a la URL directa
    -->
    <iframe 
        id="app-iframe"
        src="https://script.google.com/macros/s/AKfycbwNc7rWlhatDevQP242zv1BpZdbR0MpqtSSw_LjsNHAdVEhyYAMn5BAMvFEiiyhWqznmQ/exec"
        title="Portal Cooperativa"
        allow="fullscreen"
        allowfullscreen
        sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-popups-to-escape-sandbox allow-top-navigation">
    </iframe>
    
    <!-- Fallback: Si el iframe no funciona, mostrar un bot√≥n para abrir directamente -->
    <div id="fallback-container" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f5f5f5; z-index: 1500; justify-content: center; align-items: center; flex-direction: column;">
        <div style="text-align: center; padding: 30px; background: white; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); max-width: 500px;">
            <h2 style="color: #1976D2; margin-top: 0;">üöÄ Abrir Aplicaci√≥n</h2>
            <p style="color: #666; margin: 20px 0;">El iframe no est√° disponible. Haz clic en el bot√≥n para abrir la aplicaci√≥n directamente.</p>
            <button onclick="redirectToApp()" style="background: #1976D2; color: white; border: none; padding: 15px 30px; border-radius: 5px; cursor: pointer; font-size: 18px; font-weight: bold;">
                Abrir Aplicaci√≥n
            </button>
        </div>
    </div>
    
    <script>
        // URL de la aplicaci√≥n de producci√≥n
        const APP_URL = 'https://script.google.com/macros/s/AKfycbwNc7rWlhatDevQP242zv1BpZdbR0MpqtSSw_LjsNHAdVEhyYAMn5BAMvFEiiyhWqznmQ/exec';
        
        // Funci√≥n global para redirigir (accesible desde HTML)
        function redirectToApp() {
            window.location.href = APP_URL;
        }
        
        // Detectar errores 403 y otros errores de red
        window.addEventListener('error', function(e) {
            if (e.target && e.target.tagName === 'IFRAME') {
                console.log('Error al cargar iframe detectado');
                // El error 403 se detecta en el evento load del iframe
            }
        }, true);
        
        // Ejecutar cuando el DOM est√© listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
        
        function init() {
            const iframe = document.getElementById('app-iframe');
            const loading = document.getElementById('loading');
            const errorMessage = document.getElementById('error-message');
            const fallbackContainer = document.getElementById('fallback-container');
            let loadTimeout;
            let hasError = false;
            let checkCount = 0;
            const MAX_CHECKS = 3;
            
            // Asegurar que el loading se muestre inicialmente
            if (loading) {
                loading.classList.remove('hidden');
            }
            
            // Verificar que estamos usando la URL de producci√≥n
            if (APP_URL.includes('/dev')) {
                console.warn('‚ö†Ô∏è ADVERTENCIA: Est√°s usando la URL de desarrollo (/dev)');
                console.warn('Esta URL solo funciona para el propietario del script.');
                console.warn('Necesitas desplegar la aplicaci√≥n web y usar la URL de producci√≥n (/exec)');
            } else {
                console.log('‚úì Usando URL de producci√≥n:', APP_URL);
            }
            
            // Funci√≥n para verificar si hay error de acceso
            function checkForAccessError() {
                if (hasError) return;
                
                try {
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    if (iframeDoc && iframeDoc.body) {
                        const bodyText = (iframeDoc.body.innerText || iframeDoc.body.textContent || '').toLowerCase();
                        const bodyHTML = (iframeDoc.body.innerHTML || '').toLowerCase();
                        
                        // Detectar mensajes de error comunes de Google
                        const errorIndicators = [
                            'necesitas acceso',
                            'necesita acceso',
                            'access denied',
                            'error al cargar',
                            'error del sistema',
                            'se produjo un error',
                            'google drive',
                            'accediste como'
                        ];
                        
                        const foundError = errorIndicators.some(indicator => 
                            bodyText.includes(indicator) || bodyHTML.includes(indicator)
                        );
                        
                        if (foundError && checkCount < MAX_CHECKS) {
                            checkCount++;
                            // Esperar un poco m√°s y verificar de nuevo (puede estar cargando)
                            setTimeout(checkForAccessError, 3000);
                            return;
                    } else if (foundError) {
                        console.log('Error de acceso detectado en el iframe');
                        showError();
                        return;
                    }
                    }
                } catch (e) {
                    // CORS - no podemos acceder al contenido del iframe
                    // Esto es normal, pero significa que no podemos verificar errores
                    console.log('No se puede verificar contenido del iframe (CORS):', e.message);
                }
            }
            
            // Timeout de seguridad: ocultar loading despu√©s de m√°ximo 3 segundos
            // Esto asegura que el loading no se quede visible indefinidamente
            loadTimeout = setTimeout(function() {
                if (loading) {
                    console.log('Timeout de seguridad: Ocultando loading despu√©s de 3 segundos');
                    loading.classList.add('hidden');
                    loading.style.display = 'none';
                }
            }, 3000); // 3 segundos m√°ximo
            
            // Cuando el iframe carga (puede ser exitoso o con error)
            iframe.addEventListener('load', function() {
                clearTimeout(loadTimeout);
                console.log('‚úì Evento "load" del iframe disparado');
                
                // Ocultar el loading inmediatamente cuando el iframe carga
                // No esperamos m√°s porque el iframe ya carg√≥, aunque el contenido interno pueda seguir cargando
                if (loading) {
                    loading.classList.add('hidden');
                    loading.style.display = 'none';
                    console.log('‚úì Loading ocultado inmediatamente - iframe cargado');
                }
                
                // Verificar si hay errores despu√©s de un tiempo
                setTimeout(function() {
                    // Intentar verificar el contenido (puede fallar por CORS, pero intentamos)
                    try {
                        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                        if (iframeDoc && iframeDoc.body) {
                            const bodyText = (iframeDoc.body.innerText || iframeDoc.body.textContent || '').toLowerCase();
                            const bodyHTML = (iframeDoc.body.innerHTML || '').toLowerCase();
                            
                            // Detectar errores comunes
                            const errorIndicators = [
                                'necesitas acceso',
                                'necesita acceso',
                                'access denied',
                                '403',
                                'forbidden',
                                'error al cargar',
                                'error del sistema',
                                'se produjo un error'
                            ];
                            
                            const foundError = errorIndicators.some(indicator => 
                                bodyText.includes(indicator) || bodyHTML.includes(indicator)
                            );
                            
                            if (foundError) {
                                console.log('‚ö†Ô∏è Error detectado en el contenido del iframe');
                                showError();
                                return;
                            }
                            
                            console.log('‚úì Iframe cargado correctamente - sin errores detectados');
                        } else {
                            // No se puede acceder al contenido (CORS normal)
                            // Esto es NORMAL cuando el iframe carga desde otro dominio
                            console.log('‚úì No se puede acceder al contenido (CORS normal) - asumiendo que est√° bien');
                        }
                    } catch (e) {
                        // CORS - no podemos acceder al contenido del iframe
                        // Esto es NORMAL cuando el iframe carga desde otro dominio
                        console.log('‚úì No se puede verificar contenido (CORS normal) - asumiendo que est√° bien');
                    }
                }, 2000);
            });
            
            // Manejar errores de carga
            iframe.addEventListener('error', function() {
                clearTimeout(loadTimeout);
                console.error('Error al cargar el iframe');
                showError();
            });
            
            function showError() {
                if (hasError) return;
                hasError = true;
                if (loading) {
                    loading.classList.add('hidden');
                    loading.style.display = 'none';
                }
                if (errorMessage) errorMessage.classList.add('show');
            }
            
            // Escuchar mensajes del iframe (si el iframe env√≠a mensajes)
            window.addEventListener('message', function(event) {
                // Verificar origen por seguridad
                if (event.origin.includes('script.google.com') || event.origin.includes('googleusercontent.com')) {
                    if (event.data === 'iframe-loaded') {
                        clearTimeout(loadTimeout);
                        if (loading) {
                            loading.classList.add('hidden');
                            loading.style.display = 'none';
                        }
                        hasError = false;
                } else if (event.data === 'iframe-error') {
                    showError();
                }
                }
            });
        
            // Verificar que el iframe est√© cargando (no es necesario verificar contenido por CORS)
            // El iframe deber√≠a cargar autom√°ticamente si tiene la URL correcta
            console.log('Iframe configurado y cargando...');
        } // Cerrar funci√≥n init
    </script>
</body>
</html>
