<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Cooperativa</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
            background: #f5f5f5;
        }
        #app-iframe {
            width: 100%;
            height: 100vh;
            border: none;
            display: block;
        }
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 1000;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        .loading.hidden {
            display: none;
        }
        .error-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            max-width: 500px;
            text-align: center;
            z-index: 2000;
            display: none;
        }
        .error-message.show {
            display: block;
        }
        .error-message h2 {
            color: #d32f2f;
            margin-top: 0;
        }
        .error-message p {
            color: #666;
            line-height: 1.6;
            margin: 15px 0;
        }
        .error-message button {
            background: #2E7D32;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .error-message button:hover {
            background: #1B5E20;
        }
        .error-message a {
            color: #1976D2;
            text-decoration: none;
        }
        .error-message a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <p>Cargando aplicaci√≥n...</p>
    </div>
    
    <div class="error-message" id="error-message">
        <h2>‚ö†Ô∏è Error de Acceso</h2>
        <p>No se pudo cargar la aplicaci√≥n. Esto puede deberse a:</p>
        <ul style="text-align: left; color: #666;">
            <li>Problemas de permisos del Google Apps Script</li>
            <li>Restricciones de seguridad del navegador</li>
            <li>Problemas temporales de conexi√≥n</li>
        </ul>
        <p><strong>‚ö†Ô∏è Error 403 Detectado</strong></p>
        <p style="background: #FFEBEE; padding: 15px; border-radius: 5px; border-left: 4px solid #F44336; text-align: left;">
            <strong>Problema:</strong> Est√°s usando la URL de <strong>desarrollo</strong> (<code>/dev</code>) que solo funciona para el propietario del script.<br><br>
            <strong>Soluci√≥n:</strong> Debes desplegar la aplicaci√≥n web y usar la URL de <strong>producci√≥n</strong> (<code>/exec</code>).
        </p>
        <p><strong>Pasos para solucionar:</strong></p>
        <ol style="text-align: left; font-size: 14px; line-height: 1.8;">
            <li><strong>Ve a Google Apps Script</strong> y abre tu proyecto</li>
            <li><strong>Despliega la aplicaci√≥n:</strong>
                <ul style="margin-top: 5px;">
                    <li>Haz clic en <strong>"Implementar"</strong> ‚Üí <strong>"Nueva implementaci√≥n"</strong></li>
                    <li>Tipo: <strong>"Aplicaci√≥n web"</strong></li>
                    <li>Ejecutar como: <strong>"Yo"</strong> (tu cuenta)</li>
                    <li>Qui√©n tiene acceso: <strong>"Cualquiera"</strong> o <strong>"Cualquiera, incluso an√≥nimo"</strong></li>
                    <li>Haz clic en <strong>"Implementar"</strong></li>
                </ul>
            </li>
            <li><strong>Autoriza los permisos:</strong> La primera vez te pedir√° autorizar el acceso al Spreadsheet</li>
            <li><strong>Copia la URL de producci√≥n</strong> (termina en <code>/exec</code>, NO en <code>/dev</code>)</li>
            <li><strong>Actualiza la URL en este archivo</strong> (l√≠nea 157 y 136)</li>
            <li><strong>Verifica que el Spreadsheet</strong> est√© compartido con acceso de lectura para "Cualquiera con el enlace"</li>
        </ol>
        <p style="margin-top: 15px; padding: 15px; background: #E3F2FD; border-radius: 5px; border-left: 4px solid #1976D2;">
            <strong>üí° Soluci√≥n R√°pida:</strong><br>
            Google Apps Script tiene restricciones de seguridad que impiden cargar en iframes desde dominios externos (como GitHub Pages).<br>
            <strong>La aplicaci√≥n se abrir√° autom√°ticamente en una nueva ventana.</strong>
        </p>
        <p style="margin-top: 15px;">
            <a href="https://script.google.com/macros/s/AKfycbypwB2enQ_ZaXdPwZk1AH6q_DhFG2_BThyK8TDHXJEh/dev" target="_blank" style="color: #1976D2; text-decoration: none; font-weight: bold;">‚Üí O haz clic aqu√≠ para abrir manualmente</a>
        </p>
        <button onclick="location.reload()" style="background: #757575;">Recargar P√°gina</button>
        <button onclick="document.getElementById('error-message').classList.remove('show')" style="background: #757575;">Cerrar</button>
    </div>
    
    <!-- 
        IMPORTANTE: 
        - Reemplaza /dev con la URL de PRODUCCI√ìN despu√©s de desplegar la aplicaci√≥n web
        - La URL de desarrollo (/dev) solo funciona para el propietario del script
        - Si el iframe falla, la aplicaci√≥n se redirigir√° autom√°ticamente a la URL directa
    -->
    <iframe 
        id="app-iframe"
        src="https://script.google.com/macros/s/AKfycbypwB2enQ_ZaXdPwZk1AH6q_DhFG2_BThyK8TDHXJEh/dev"
        title="Portal Cooperativa"
        allow="fullscreen"
        allowfullscreen
        sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-popups-to-escape-sandbox allow-top-navigation">
    </iframe>
    
    <!-- Fallback: Si el iframe no funciona, mostrar un bot√≥n para abrir directamente -->
    <div id="fallback-container" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f5f5f5; z-index: 1500; justify-content: center; align-items: center; flex-direction: column;">
        <div style="text-align: center; padding: 30px; background: white; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); max-width: 500px;">
            <h2 style="color: #1976D2; margin-top: 0;">üöÄ Abrir Aplicaci√≥n</h2>
            <p style="color: #666; margin: 20px 0;">El iframe no est√° disponible. Haz clic en el bot√≥n para abrir la aplicaci√≥n directamente.</p>
            <button onclick="redirectToApp()" style="background: #1976D2; color: white; border: none; padding: 15px 30px; border-radius: 5px; cursor: pointer; font-size: 18px; font-weight: bold;">
                Abrir Aplicaci√≥n
            </button>
        </div>
    </div>
    
    <script>
        // ‚ö†Ô∏è IMPORTANTE: Si est√°s usando /dev, solo funcionar√° para ti
        // Necesitas desplegar la aplicaci√≥n web y usar la URL de producci√≥n (/exec)
        // URL de la aplicaci√≥n - CAMBIA /dev por /exec despu√©s de desplegar
        const APP_URL = 'https://script.google.com/macros/s/AKfycbypwB2enQ_ZaXdPwZk1AH6q_DhFG2_BThyK8TDHXJEh/dev';
        
        // Funci√≥n global para redirigir (accesible desde HTML)
        function redirectToApp() {
            window.location.href = APP_URL;
        }
        
        // Detectar errores 403 y otros errores de red
        window.addEventListener('error', function(e) {
            if (e.target && e.target.tagName === 'IFRAME') {
                console.log('Error al cargar iframe detectado');
                // El error 403 se detecta en el evento load del iframe
            }
        }, true);
        
        // Ejecutar cuando el DOM est√© listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
        
        function init() {
            const iframe = document.getElementById('app-iframe');
            const loading = document.getElementById('loading');
            const errorMessage = document.getElementById('error-message');
            const fallbackContainer = document.getElementById('fallback-container');
            let loadTimeout;
            let hasError = false;
            let checkCount = 0;
            const MAX_CHECKS = 3;
            
            // Asegurar que el loading se muestre inicialmente
            if (loading) {
                loading.classList.remove('hidden');
            }
            
            // ‚ö†Ô∏è DETECCI√ìN INMEDIATA: Si estamos usando /dev, mostrar advertencia
            if (APP_URL.includes('/dev')) {
                console.warn('‚ö†Ô∏è ADVERTENCIA: Est√°s usando la URL de desarrollo (/dev)');
                console.warn('Esta URL solo funciona para el propietario del script.');
                console.warn('Necesitas desplegar la aplicaci√≥n web y usar la URL de producci√≥n (/exec)');
                // Esperar un poco y luego verificar si hay error
                setTimeout(function() {
                    // Si despu√©s de 3 segundos no hay contenido, es probable que sea 403
                    try {
                        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                        if (!iframeDoc || !iframeDoc.body || iframeDoc.body.innerHTML.trim() === '' || 
                            iframeDoc.body.innerHTML.trim().length < 100) {
                            console.log('Iframe vac√≠o detectado con /dev - mostrando error');
                            showErrorWithRedirect();
                        }
                    } catch (e) {
                        // No podemos verificar por CORS, pero si es /dev, es muy probable 403
                        console.log('No se puede verificar (CORS) pero usando /dev - probable 403');
                        showErrorWithRedirect();
                    }
                }, 3000);
            }
            
            // Funci√≥n para verificar si hay error de acceso
            function checkForAccessError() {
                if (hasError) return;
                
                try {
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    if (iframeDoc && iframeDoc.body) {
                        const bodyText = (iframeDoc.body.innerText || iframeDoc.body.textContent || '').toLowerCase();
                        const bodyHTML = (iframeDoc.body.innerHTML || '').toLowerCase();
                        
                        // Detectar mensajes de error comunes de Google
                        const errorIndicators = [
                            'necesitas acceso',
                            'necesita acceso',
                            'access denied',
                            'error al cargar',
                            'error del sistema',
                            'se produjo un error',
                            'google drive',
                            'accediste como'
                        ];
                        
                        const foundError = errorIndicators.some(indicator => 
                            bodyText.includes(indicator) || bodyHTML.includes(indicator)
                        );
                        
                        if (foundError && checkCount < MAX_CHECKS) {
                            checkCount++;
                            // Esperar un poco m√°s y verificar de nuevo (puede estar cargando)
                            setTimeout(checkForAccessError, 3000);
                            return;
                        } else if (foundError) {
                            console.log('Error de acceso detectado, redirigiendo...');
                            showErrorWithRedirect();
                            return;
                        }
                    }
                } catch (e) {
                    // CORS - no podemos acceder al contenido del iframe
                    // Esto es normal, pero significa que no podemos verificar errores
                    console.log('No se puede verificar contenido del iframe (CORS):', e.message);
                }
            }
            
            // Timeout para detectar si el iframe no carga
            loadTimeout = setTimeout(function() {
                if (!hasError) {
                    checkForAccessError();
                    // Si despu√©s de verificar a√∫n no hay contenido, mostrar error
                    setTimeout(function() {
                        if (!hasError) {
                            try {
                                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                                if (!iframeDoc || !iframeDoc.body || iframeDoc.body.innerHTML.trim() === '') {
                                    showErrorWithRedirect();
                                }
                            } catch (e) {
                                // No podemos verificar, pero ofrecer redirecci√≥n
                                showErrorWithRedirect();
                            }
                        }
                    }, 5000);
                }
            }, 8000); // 8 segundos
            
            // Cuando el iframe carga (puede ser exitoso o con error)
            iframe.addEventListener('load', function() {
                clearTimeout(loadTimeout);
                
                // Verificar inmediatamente si hay errores
                setTimeout(function() {
                    // Intentar verificar el contenido
                    try {
                        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                        if (iframeDoc && iframeDoc.body) {
                            const bodyText = (iframeDoc.body.innerText || iframeDoc.body.textContent || '').toLowerCase();
                            const bodyHTML = (iframeDoc.body.innerHTML || '').toLowerCase();
                            
                            // Detectar errores comunes
                            const errorIndicators = [
                                'necesitas acceso',
                                'necesita acceso',
                                'access denied',
                                '403',
                                'forbidden',
                                'error al cargar',
                                'error del sistema',
                                'se produjo un error',
                                'google drive',
                                'accediste como'
                            ];
                            
                            const foundError = errorIndicators.some(indicator => 
                                bodyText.includes(indicator) || bodyHTML.includes(indicator)
                            );
                            
                            if (foundError) {
                                console.log('Error detectado en el contenido del iframe');
                                showErrorWithRedirect();
                                return;
                            }
                            
                            // Si no hay error, ocultar loading
                            if (loading) loading.classList.add('hidden');
                            console.log('Iframe cargado correctamente');
                        } else {
                            // No se puede acceder al contenido (CORS normal o error 403)
                            console.log('No se puede acceder al contenido del iframe - puede ser error 403 o CORS');
                            // Si no podemos verificar, asumir que hay un problema y redirigir
                            showErrorWithRedirect();
                        }
                    } catch (e) {
                        // CORS - no podemos acceder al contenido
                        // Si es un error 403, el iframe puede estar vac√≠o o mostrar error
                        console.log('Error al verificar iframe (probable CORS o 403):', e.message);
                        // Verificar si el iframe tiene alg√∫n contenido visible
                        setTimeout(function() {
                            // Si despu√©s de 3 segundos no hay contenido visible, asumir error
                            try {
                                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                                if (!iframeDoc || !iframeDoc.body || iframeDoc.body.innerHTML.trim() === '') {
                                    console.log('Iframe parece estar vac√≠o - probable error 403');
                                    showErrorWithRedirect();
                                } else {
                                    // Hay contenido, asumir que est√° bien
                                    if (loading) loading.classList.add('hidden');
                                }
                            } catch (e2) {
                                // No podemos verificar, pero ofrecer redirecci√≥n por si acaso
                                console.log('No se puede verificar contenido - ofreciendo redirecci√≥n');
                                showErrorWithRedirect();
                            }
                        }, 3000);
                    }
                }, 1000);
            });
            
            // Manejar errores de carga
            iframe.addEventListener('error', function() {
                clearTimeout(loadTimeout);
                showErrorWithRedirect();
            });
            
            function showError() {
                if (hasError) return;
                hasError = true;
                if (loading) loading.classList.add('hidden');
                if (errorMessage) errorMessage.classList.add('show');
            }
            
            function showErrorWithRedirect() {
                if (hasError) return;
                hasError = true;
                if (loading) loading.classList.add('hidden');
                
                // Verificar si estamos usando /dev
                const usingDev = APP_URL.includes('/dev');
                let errorText = '';
                
                if (usingDev) {
                    errorText = '<p style="background: #FFF3CD; padding: 15px; border-radius: 5px; border-left: 4px solid #FFC107; margin: 15px 0;"><strong>‚ö†Ô∏è Problema Detectado:</strong><br>Est√°s usando la URL de desarrollo (<code>/dev</code>). Esta URL solo funciona para el propietario del script.<br><br><strong>Soluci√≥n:</strong> Debes desplegar la aplicaci√≥n web en Google Apps Script y usar la URL de producci√≥n (termina en <code>/exec</code>).</p>';
                }
                
                // Actualizar el mensaje de error con opci√≥n de redirecci√≥n
                const errorDiv = errorMessage;
                const currentHTML = errorDiv.innerHTML;
                
                // Agregar bot√≥n de redirecci√≥n autom√°tica
                if (!currentHTML.includes('redirect-button')) {
                    // Insertar el mensaje sobre /dev si aplica
                    if (errorText && !currentHTML.includes('URL de desarrollo')) {
                        const errorTextDiv = document.createElement('div');
                        errorTextDiv.innerHTML = errorText;
                        errorDiv.insertBefore(errorTextDiv, errorDiv.firstChild.nextSibling);
                    }
                const redirectButton = document.createElement('button');
                redirectButton.className = 'redirect-button';
                redirectButton.style.cssText = 'background: #1976D2; color: white; border: none; padding: 15px 30px; border-radius: 5px; cursor: pointer; font-size: 18px; font-weight: bold; margin: 15px 5px;';
                redirectButton.textContent = 'üöÄ Abrir Aplicaci√≥n Directamente';
                redirectButton.onclick = redirectToApp;
                
                const autoRedirectInfo = document.createElement('p');
                autoRedirectInfo.style.cssText = 'color: #1976D2; font-weight: bold; margin-top: 20px;';
                autoRedirectInfo.innerHTML = '‚è±Ô∏è Redirigiendo autom√°ticamente en <span id="countdown">5</span> segundos...';
                autoRedirectInfo.id = 'auto-redirect-info';
                
                errorDiv.appendChild(redirectButton);
                errorDiv.appendChild(autoRedirectInfo);
                
                // Contador regresivo y redirecci√≥n autom√°tica
                let countdown = 5;
                const countdownSpan = document.getElementById('countdown');
                const countdownInterval = setInterval(function() {
                    countdown--;
                    if (countdownSpan) {
                        countdownSpan.textContent = countdown;
                    }
                    if (countdown <= 0) {
                        clearInterval(countdownInterval);
                        redirectToApp();
                    }
                }, 1000);
            }
            
                if (errorMessage) errorMessage.classList.add('show');
            }
            
            // Escuchar mensajes del iframe (si el iframe env√≠a mensajes)
            window.addEventListener('message', function(event) {
                // Verificar origen por seguridad
                if (event.origin.includes('script.google.com') || event.origin.includes('googleusercontent.com')) {
                    if (event.data === 'iframe-loaded') {
                        clearTimeout(loadTimeout);
                        if (loading) loading.classList.add('hidden');
                        hasError = false;
                    } else if (event.data === 'iframe-error') {
                        showErrorWithRedirect();
                    }
                }
            });
        
            // Intentar detectar si el iframe est√° bloqueado por pol√≠ticas de seguridad
            setTimeout(function() {
                if (!hasError) {
                    try {
                        // Intentar acceder al iframe para ver si est√° bloqueado
                        const test = iframe.contentWindow;
                        if (!test) {
                            console.log('Iframe puede estar bloqueado');
                            showErrorWithRedirect();
                        }
                    } catch (e) {
                        // Esto es normal por CORS, no es un error
                    }
                }
            }, 5000);
        } // Cerrar funci√≥n init
    </script>
</body>
</html>
